name: Sync Package Lock

on:
  pull_request:
    types: [labeled, synchronize]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  sync-lockfile:
    # Only run on PRs from release-please bot with "autorelease: pending" label
    if: "${{ contains(github.event.pull_request.labels.*.name, 'autorelease: pending') && github.actor == 'tambo-bot' }}"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

      - uses: ./.github/actions/setup-tools
        with:
          frozen: false

      - name: Regenerate package-lock.json
        run: npm install --package-lock-only --ignore-scripts --no-audit --no-fund

      - name: Check for changes
        id: check
        shell: bash
        run: |
          set -euo pipefail

          untracked_files="$(git ls-files --others --exclude-standard)"
          if [[ -n "$untracked_files" ]]; then
            echo "Unexpected untracked files detected:" >&2
            echo "$untracked_files" >&2
            git status --porcelain >&2
            exit 1
          fi

          changed_files="$(git diff --name-only HEAD | sort -u)"
          if [[ -z "$changed_files" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if echo "$changed_files" | grep -qv '^package-lock\.json$'; then
            echo "Unexpected file changes detected:" >&2
            echo "$changed_files" >&2
            git status --porcelain >&2
            exit 1
          fi

          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Commit lockfile changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "tambo-bot"
          git config user.email "bots@tambo.co"
          git add package-lock.json
          git commit -m "chore: sync package-lock.json"
          git push origin "HEAD:${{ github.head_ref }}"
