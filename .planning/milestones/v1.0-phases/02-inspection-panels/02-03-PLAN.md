---
phase: 02-inspection-panels
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/app/(authed)/devtools/components/registry-panel.tsx
  - apps/web/app/(authed)/devtools/components/schema-viewer.tsx
  - apps/web/app/(authed)/devtools/components/error-banner.tsx
  - apps/web/app/(authed)/devtools/components/filter-bar.tsx
  - apps/web/app/(authed)/devtools/hooks/use-devtools-filters.ts
  - apps/web/app/(authed)/devtools/page.tsx
autonomous: true

must_haves:
  truths:
    - "Developer can view registered components with name, description, and prop schema"
    - "Developer can view registered tools with name, description, and input/output schema"
    - "Developer can view connected MCP servers"
    - "Streaming errors, tool call failures, and connection issues appear prominently without digging into state"
    - "Developer can filter threads by status and messages by role/content type"
    - "Developer can search across message content and tool names"
  artifacts:
    - path: "apps/web/app/(authed)/devtools/components/registry-panel.tsx"
      provides: "Component list, tool list, MCP server list"
      exports: ["RegistryPanel"]
    - path: "apps/web/app/(authed)/devtools/components/schema-viewer.tsx"
      provides: "JSON Schema rendered as readable property list"
      exports: ["SchemaViewer"]
    - path: "apps/web/app/(authed)/devtools/components/error-banner.tsx"
      provides: "Prominent error display for streaming/tool/connection errors"
      exports: ["ErrorBanner"]
    - path: "apps/web/app/(authed)/devtools/components/filter-bar.tsx"
      provides: "Thread status filter, message role/type filter, search input"
      exports: ["FilterBar"]
    - path: "apps/web/app/(authed)/devtools/hooks/use-devtools-filters.ts"
      provides: "Filter and search state management with filtering logic"
      exports: ["useDevtoolsFilters"]
  key_links:
    - from: "apps/web/app/(authed)/devtools/page.tsx"
      to: "apps/web/app/(authed)/devtools/components/registry-panel.tsx"
      via: "snapshot.registry passed as prop"
      pattern: "RegistryPanel"
    - from: "apps/web/app/(authed)/devtools/page.tsx"
      to: "apps/web/app/(authed)/devtools/components/error-banner.tsx"
      via: "snapshot.errors passed as prop"
      pattern: "ErrorBanner"
    - from: "apps/web/app/(authed)/devtools/hooks/use-devtools-filters.ts"
      to: "apps/web/app/(authed)/devtools/page.tsx"
      via: "filtered threads/messages consumed by panels"
      pattern: "useDevtoolsFilters"
---

<objective>
Build the component/tool registry panel, MCP server view, error banner, and filtering/search for the devtools dashboard.

Purpose: Completes the inspection experience: registry visibility, error surfacing, and the ability to find specific data quickly.
Output: Registry panel, schema viewer, error banner, filter bar, and search -- all wired into the page.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-inspection-panels/02-RESEARCH.md
@.planning/phases/02-inspection-panels/02-01-SUMMARY.md

@apps/web/app/(authed)/devtools/page.tsx
@apps/web/app/(authed)/devtools/hooks/use-devtools-connection.ts
@apps/web/devtools-server/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create registry panel, schema viewer, and error banner</name>
  <files>
    apps/web/app/(authed)/devtools/components/registry-panel.tsx
    apps/web/app/(authed)/devtools/components/schema-viewer.tsx
    apps/web/app/(authed)/devtools/components/error-banner.tsx
  </files>
  <action>
    1. **Create `schema-viewer.tsx`:**
       - Export `SchemaViewer` with props: `{ schema: Record<string, unknown> | undefined, label?: string }`
       - If schema is undefined or empty, render "No schema" in muted text
       - If schema has `properties` (JSON Schema object): render each property as a row showing name, type, description, and required status
       - For nested schemas (objects within objects), use the `JsonTreeViewer` from Plan 02 for drill-down
       - For non-object schemas or unrecognized shapes, fall back to `<JsonTreeViewer data={schema} />`
       - Keep it simple -- ~60 lines. This is a convenience view, not a full JSON Schema renderer.

    2. **Create `registry-panel.tsx`:**
       - Export `RegistryPanel` with props: `{ registry: SnapshotRegistry }` where SnapshotRegistry is the registry shape from enriched snapshot types
       - Use shadcn `<Tabs>` with three tabs: "Components", "Tools", "MCP Servers"
       - **Components tab:** List each component as a card showing name (font-mono bold), description, and a collapsible `<SchemaViewer schema={c.propsSchema} label="Props Schema" />`. If no components, show "No components registered".
       - **Tools tab:** List each tool as a card showing name (font-mono bold), description, collapsible `<SchemaViewer schema={t.inputSchema} label="Input Schema" />` and `<SchemaViewer schema={t.outputSchema} label="Output Schema" />`. If no tools, show "No tools registered".
       - **MCP Servers tab:** List each server showing name, URL, status badge. If no servers or mcpServers is undefined, show "No MCP servers connected".
       - Use shadcn `<Accordion>` for the collapsible schema sections within each card

    3. **Create `error-banner.tsx`:**
       - Export `ErrorBanner` with props: `{ errors: SnapshotError[] }` where SnapshotError is the error shape from enriched snapshot types
       - If errors empty, render nothing (return null)
       - Render a prominent banner at top: `bg-destructive/10 border-destructive` rounded container
       - Show count: "N error(s)" as header
       - List each error: icon (AlertTriangle from lucide-react), type badge (streaming/tool_call/connection), message text, threadId if present, relative timestamp
       - If more than 3 errors, show first 3 with "Show N more" expand button (use `useState` toggle)

  </action>
  <verify>
    `npm run check-types -w apps/web` and `npm run lint -w apps/web` pass.
  </verify>
  <done>
    RegistryPanel shows components, tools, and MCP servers in tabs with schema inspection. ErrorBanner surfaces errors prominently. SchemaViewer renders JSON Schema properties readably.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create filter bar, search, and integrate all panels into page</name>
  <files>
    apps/web/app/(authed)/devtools/hooks/use-devtools-filters.ts
    apps/web/app/(authed)/devtools/components/filter-bar.tsx
    apps/web/app/(authed)/devtools/page.tsx
  </files>
  <action>
    1. **Create `use-devtools-filters.ts`:**
       - Export `useDevtoolsFilters(snapshot)` hook that takes the current snapshot (or undefined)
       - Internal state: `threadStatusFilter: "all" | "idle" | "streaming" | "waiting"`, `messageRoleFilter: "all" | "user" | "assistant" | "system"`, `messageContentTypeFilter: "all" | "text" | "tool_use" | "tool_result" | "component"`, `searchQuery: string`
       - Computed: `filteredThreads` -- filter snapshot.threads by status if not "all", then by search query (search in thread name, message text content, tool names in tool_use blocks)
       - Computed: `filterMessages(messages)` -- given a thread's messages, filter by role if not "all", by content type if not "all", and by search query matching content text or tool names
       - Export: all filter states, setters, `filteredThreads`, `filterMessages` function
       - Use `useMemo` for filtered results to avoid recomputation

    2. **Create `filter-bar.tsx`:**
       - Export `FilterBar` with props from useDevtoolsFilters: filter values and setters
       - Render a horizontal bar with:
         - Thread status filter: shadcn `<Select>` with options All/Idle/Streaming/Waiting
         - Message role filter: shadcn `<Select>` with options All/User/Assistant/System
         - Content type filter: shadcn `<Select>` with options All/Text/Tool Use/Tool Result/Component
         - Search input: shadcn `<Input>` with search icon, placeholder "Search messages and tools...", debounced 200ms via internal useState + useEffect
       - Compact layout: flex row with gap-2, wrapping on mobile

    3. **Update `page.tsx` to integrate everything:**
       - NOTE: Plan 02 also modifies page.tsx (wave 2 parallel). If Plan 02 completes first, build on its layout. If this plan runs first or concurrently, the page needs the full layout. To handle this: read the current page.tsx at execution time and build on whatever state it's in.
       - Add `<ErrorBanner errors={snapshot?.errors ?? []} />` at the top, below ConnectionStatus
       - Add `<FilterBar>` below the error banner
       - Add shadcn `<Tabs>` to switch between "Inspector" and "Registry" views:
         - "Inspector" tab: the thread list + message detail layout (from Plan 02 or built here if Plan 02 hasn't run)
         - "Registry" tab: `<RegistryPanel registry={snapshot?.registry} />`
       - Wire `useDevtoolsFilters(snapshot)` and pass `filteredThreads` to `ThreadListPanel` instead of raw threads. Pass `filterMessages` to `MessageDetailView` to filter the selected thread's messages.
       - If ThreadListPanel/MessageDetailView don't exist yet (Plan 02 hasn't run), create minimal placeholder divs that show the filtered data as JSON -- Plan 02 will replace them.

  </action>
  <verify>
    1. `npm run check-types` passes
    2. `npm run lint` passes
    3. `npm run build -w apps/web` succeeds
  </verify>
  <done>
    Registry panel shows components/tools/MCP in tabs. Errors appear prominently at top. Filters narrow threads by status and messages by role/content type. Search finds content across messages and tool names. All panels integrated into the devtools page.
  </done>
</task>

</tasks>

<verification>
1. Type check: `npm run check-types` passes
2. Lint: `npm run lint` passes
3. Build: `npm run build -w apps/web` succeeds
4. Visual: Registry tabs show component/tool/MCP lists. Error banner visible when errors present. Filters narrow results. Search works.
</verification>

<success_criteria>

- Components tab lists registered components with name, description, expandable prop schema
- Tools tab lists registered tools with name, description, expandable input/output schemas
- MCP Servers tab lists connected servers with name, URL, status
- Errors (streaming, tool_call, connection) appear in a prominent banner without user needing to dig
- Thread status filter narrows thread list
- Message role and content type filters narrow message detail view
- Search query matches across message text content and tool names
- All panels integrated into the devtools page layout
  </success_criteria>

<output>
After completion, create `.planning/phases/02-inspection-panels/02-03-SUMMARY.md`
</output>
