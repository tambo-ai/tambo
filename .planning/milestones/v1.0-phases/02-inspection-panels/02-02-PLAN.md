---
phase: 02-inspection-panels
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/app/(authed)/devtools/components/json-tree-viewer.tsx
  - apps/web/app/(authed)/devtools/components/thread-list-panel.tsx
  - apps/web/app/(authed)/devtools/components/message-detail-view.tsx
  - apps/web/app/(authed)/devtools/components/content-block-viewer.tsx
  - apps/web/app/(authed)/devtools/components/streaming-state-badge.tsx
  - apps/web/app/(authed)/devtools/page.tsx
autonomous: true

must_haves:
  truths:
    - "Developer can see all threads listed with name, status, message count, and timestamps"
    - "Developer can select a thread and see its messages with role, content blocks, and timestamps"
    - "Developer can expand any message to see content blocks (text, component, tool_use, tool_result) with full detail"
    - "Developer can expand nested data via a collapsible JSON tree"
    - "Streaming status is visible per thread"
  artifacts:
    - path: "apps/web/app/(authed)/devtools/components/thread-list-panel.tsx"
      provides: "Thread list with status badges, selection, message counts"
      exports: ["ThreadListPanel"]
    - path: "apps/web/app/(authed)/devtools/components/message-detail-view.tsx"
      provides: "Message list for selected thread"
      exports: ["MessageDetailView"]
    - path: "apps/web/app/(authed)/devtools/components/content-block-viewer.tsx"
      provides: "Renders text/tool_use/tool_result/component content blocks"
      exports: ["ContentBlockViewer"]
    - path: "apps/web/app/(authed)/devtools/components/json-tree-viewer.tsx"
      provides: "Collapsible JSON tree for nested data"
      exports: ["JsonTreeViewer"]
    - path: "apps/web/app/(authed)/devtools/page.tsx"
      provides: "Updated layout with thread panel and message detail"
      contains: "ThreadListPanel"
  key_links:
    - from: "apps/web/app/(authed)/devtools/page.tsx"
      to: "apps/web/app/(authed)/devtools/hooks/use-devtools-connection.ts"
      via: "snapshots from hook"
      pattern: "snapshots"
    - from: "apps/web/app/(authed)/devtools/components/message-detail-view.tsx"
      to: "apps/web/app/(authed)/devtools/components/content-block-viewer.tsx"
      via: "renders content blocks"
      pattern: "ContentBlockViewer"
    - from: "apps/web/app/(authed)/devtools/components/content-block-viewer.tsx"
      to: "apps/web/app/(authed)/devtools/components/json-tree-viewer.tsx"
      via: "renders nested data"
      pattern: "JsonTreeViewer"
---

<objective>
Build the thread list panel, message detail view, content block viewer, and JSON tree inspector in the devtools dashboard.

Purpose: These panels let developers see thread state, drill into messages, and inspect any nested data -- the core inspection experience.
Output: Working thread inspector UI consuming snapshots from Plan 01's data pipeline.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-inspection-panels/02-RESEARCH.md
@.planning/phases/02-inspection-panels/02-01-SUMMARY.md

@apps/web/app/(authed)/devtools/page.tsx
@apps/web/app/(authed)/devtools/hooks/use-devtools-connection.ts
@apps/web/app/(authed)/devtools/components/client-card.tsx
@apps/web/app/(authed)/devtools/components/connection-status.tsx
@apps/web/devtools-server/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JSON tree viewer and content block viewer components</name>
  <files>
    apps/web/app/(authed)/devtools/components/json-tree-viewer.tsx
    apps/web/app/(authed)/devtools/components/content-block-viewer.tsx
    apps/web/app/(authed)/devtools/components/streaming-state-badge.tsx
  </files>
  <action>
    1. **Create `json-tree-viewer.tsx`:**
       - Export `JsonTreeViewer` component with props: `{ data: unknown, label?: string, defaultExpanded?: boolean }`
       - For primitives (null, undefined, string, number, boolean): render inline with `font-mono text-sm`. Color-code: strings green-600, numbers blue-600, booleans orange-600, null/undefined gray-400.
       - For arrays/objects: use shadcn `<Collapsible>` with `<CollapsibleTrigger>` showing label + entry count (e.g., "input (3 keys)") and `<CollapsibleContent>` rendering children recursively
       - Add indentation via `pl-4` on nested content
       - Add a chevron icon (ChevronRight from lucide-react, rotate when open) on the trigger
       - Keep it under ~80 lines. No external deps beyond shadcn Collapsible.

    2. **Create `content-block-viewer.tsx`:**
       - Export `ContentBlockViewer` with props `{ block: SerializedContent }` (use the serialized content type from devtools-server/types.ts)
       - Switch on `block.type`:
         - `"text"`: render `<pre className="whitespace-pre-wrap text-sm">{block.text}</pre>`
         - `"tool_use"`: render shadcn `<Badge>Tool Call</Badge>` + tool name in `font-mono`, then `<JsonTreeViewer data={block.input} label="input" />`
         - `"tool_result"`: render `<Badge variant={block.isError ? "destructive" : "default"}>` with "Tool Error" or "Tool Result", then `<JsonTreeViewer data={block.content} label="result" />`
         - `"component"`: render `<Badge variant="secondary">Component</Badge>` + component name, then `<JsonTreeViewer data={block.props} label="props" />`
         - `"resource"`: render `<Badge variant="outline">Resource</Badge>` + URI, then `<JsonTreeViewer data={block.content} label="content" />`
         - default: render `<JsonTreeViewer data={block} label="unknown" />`

    3. **Create `streaming-state-badge.tsx`:**
       - Export `StreamingStateBadge` with props `{ status: string, error?: { message: string } }`
       - Render a shadcn `<Badge>` with variant based on status: "idle" -> outline, "streaming" -> default with a subtle pulse animation class, "waiting" -> secondary, error present -> destructive
       - Show status text; if error, show error message as tooltip or small text below

  </action>
  <verify>
    `npm run check-types -w apps/web` and `npm run lint -w apps/web` pass.
  </verify>
  <done>
    JsonTreeViewer renders any nested JSON data with expand/collapse. ContentBlockViewer renders all content block types. StreamingStateBadge shows thread streaming status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create thread list panel, message detail view, and wire into page</name>
  <files>
    apps/web/app/(authed)/devtools/components/thread-list-panel.tsx
    apps/web/app/(authed)/devtools/components/message-detail-view.tsx
    apps/web/app/(authed)/devtools/page.tsx
  </files>
  <action>
    1. **Create `thread-list-panel.tsx`:**
       - Export `ThreadListPanel` with props: `{ threads: SnapshotThread[], selectedThreadId: string | null, onSelectThread: (id: string) => void }`
       - Where `SnapshotThread` is the thread shape from the enriched snapshot type in devtools-server/types
       - Render a scrollable list (shadcn `<ScrollArea>`) of thread items
       - Each item shows: thread name (or "Thread {id.slice(0,8)}" if no name), `<StreamingStateBadge>` for status, message count as small text, timestamps (createdAt/updatedAt) as relative time (e.g., "2m ago" -- use a simple `timeAgo` helper, ~10 lines)
       - Selected thread highlighted with `bg-accent` class
       - Click handler calls `onSelectThread(thread.id)`
       - If threads array is empty, show "No threads" placeholder

    2. **Create `message-detail-view.tsx`:**
       - Export `MessageDetailView` with props: `{ messages: SnapshotMessage[], threadName?: string }`
       - Render in a `<ScrollArea>` with auto-scroll to bottom
       - Each message: show role badge (user=blue, assistant=purple, system=gray) via shadcn `<Badge>`, timestamp if available, then iterate content blocks rendering `<ContentBlockViewer>` for each
       - Messages separated by a subtle divider or gap
       - If messages empty, show "No messages" placeholder
       - If `threadName` provided, show it as a header

    3. **Update `page.tsx`:**
       - Import `ThreadListPanel`, `MessageDetailView`, and snapshot data from `useDevtoolsConnection`
       - Keep existing `ConnectionStatus` and `ClientCard` section at top
       - Below connection section, add the inspection area: a two-column layout (`grid grid-cols-[320px_1fr]` on lg, stacked on mobile)
         - Left column: `<ThreadListPanel>` showing threads from selected session's snapshot
         - Right column: `<MessageDetailView>` showing messages for the selected thread
       - Add `selectedThreadId` state. When user selects a thread from the list, show its messages.
       - The snapshot data comes from `useDevtoolsConnection` hook's `snapshots` and `selectedSessionId`. Get current snapshot: `snapshots.get(selectedSessionId)`. Get threads from `snapshot.threads`. Get selected thread's messages from `snapshot.threads.find(t => t.id === selectedThreadId)?.messages`.
       - When no snapshot available (no SDK connected or no data yet), show the existing empty/instruction state
       - Add a session selector dropdown (shadcn `<Select>`) above the panels if multiple clients are connected, using client list from hook. This sets `selectedSessionId`.

  </action>
  <verify>
    1. `npm run check-types` passes
    2. `npm run lint` passes
    3. `npm run build -w apps/web` succeeds (confirms no SSR issues)
  </verify>
  <done>
    Thread list panel renders all threads with status, selection works. Message detail view shows messages with content blocks and JSON tree expansion. Page layout has two-column inspection UI. Session selector allows switching between connected SDK clients.
  </done>
</task>

</tasks>

<verification>
1. Type check: `npm run check-types` passes
2. Lint: `npm run lint` passes
3. Build: `npm run build -w apps/web` succeeds
4. Visual: Components render thread list, message detail, collapsible JSON trees, content block types
</verification>

<success_criteria>

- Thread list shows all threads with name, status badge, message count, timestamps
- Selecting a thread shows its messages in the detail view
- Each message shows role badge, content blocks rendered by type
- tool_use blocks show tool name + input as JSON tree
- tool_result blocks show result data (with error variant)
- component blocks show component name + props as JSON tree
- JSON tree allows expand/collapse of nested objects/arrays
- Streaming status visible per thread
- Session selector available when multiple SDK clients connected
  </success_criteria>

<output>
After completion, create `.planning/phases/02-inspection-panels/02-02-SUMMARY.md`
</output>
