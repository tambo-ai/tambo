---
phase: 03-streaming-visibility
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/web/app/(authed)/devtools/lib/ring-buffer.ts
  - apps/web/app/(authed)/devtools/lib/event-categorizer.ts
  - apps/web/app/(authed)/devtools/hooks/use-devtools-events.ts
  - apps/web/app/(authed)/devtools/components/timeline-panel.tsx
  - apps/web/app/(authed)/devtools/components/timeline-event-row.tsx
  - apps/web/app/(authed)/devtools/components/timeline-event-detail.tsx
  - apps/web/app/(authed)/devtools/page.tsx
autonomous: true

must_haves:
  truths:
    - "Developer can see a chronological timeline of AG-UI events as they arrive in real-time"
    - "Events are timestamped and color-coded by category (run/text/tool/component/thinking/other)"
    - "Developer can click an event to see its full payload in a detail panel"
    - "Timeline handles high-frequency events without UI jank"
  artifacts:
    - path: "apps/web/app/(authed)/devtools/lib/ring-buffer.ts"
      provides: "RingBuffer class with push, toArray, length, droppedCount"
      contains: "class RingBuffer"
    - path: "apps/web/app/(authed)/devtools/lib/event-categorizer.ts"
      provides: "categorizeEvent, CATEGORY_COLORS, summarizeEvent functions"
      contains: "categorizeEvent"
    - path: "apps/web/app/(authed)/devtools/hooks/use-devtools-events.ts"
      provides: "useDevtoolsEvents hook with RAF-batched updates"
      contains: "requestAnimationFrame"
    - path: "apps/web/app/(authed)/devtools/components/timeline-panel.tsx"
      provides: "TimelinePanel with virtualized scroll and auto-scroll"
      exports: ["TimelinePanel"]
    - path: "apps/web/app/(authed)/devtools/components/timeline-event-row.tsx"
      provides: "Memoized event row with color badge and timestamp"
      exports: ["TimelineEventRow"]
  key_links:
    - from: "use-devtools-events.ts"
      to: "use-devtools-connection.ts streamEvents"
      via: "subscribes to stream events from connection hook"
      pattern: "streamEvents"
    - from: "timeline-panel.tsx"
      to: "use-devtools-events.ts"
      via: "consumes events array and addEvent"
      pattern: "useDevtoolsEvents"
    - from: "page.tsx"
      to: "timeline-panel.tsx"
      via: "new Timeline tab in Tabs component"
      pattern: "TabsTrigger.*Timeline"
---

<objective>
Build the event timeline panel with real-time event display, color-coded categories, click-to-inspect detail view, and performance-optimized rendering.

Purpose: This is the primary UI for STRM-01, STRM-02, STRM-03, STRM-06 -- the core streaming visibility feature.
Output: Timeline tab in devtools page showing color-coded events with detail panel, handling high-frequency updates without jank.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-streaming-visibility/03-RESEARCH.md
@.planning/phases/03-streaming-visibility/03-01-SUMMARY.md

@apps/web/app/(authed)/devtools/page.tsx
@apps/web/app/(authed)/devtools/hooks/use-devtools-connection.ts
@apps/web/app/(authed)/devtools/components/thread-list-panel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ring buffer, event categorizer, and RAF-batched events hook</name>
  <files>
    apps/web/app/(authed)/devtools/lib/ring-buffer.ts
    apps/web/app/(authed)/devtools/lib/event-categorizer.ts
    apps/web/app/(authed)/devtools/hooks/use-devtools-events.ts
  </files>
  <action>
    1. Create `ring-buffer.ts`:
       - Generic `RingBuffer<T>` class with configurable capacity (default 5000)
       - `push(item: T)` -- O(1) circular write
       - `toArray(): T[]` -- returns items in chronological order
       - `length` getter -- current item count
       - `droppedCount` getter -- total items evicted (track with a `totalPushed` counter: `droppedCount = Math.max(0, totalPushed - capacity)`)
       - `clear()` -- reset buffer

    2. Create `event-categorizer.ts`:
       - `TimelineEvent` interface: `{ seq: number; timestamp: number; threadId: string; eventType: string; category: EventCategory; summary: string; payload: Record<string, unknown> }`
       - `EventCategory` type: `"run" | "text" | "tool" | "component" | "thinking" | "other"`
       - `categorizeEvent(eventType: string): EventCategory` -- categorize by prefix:
         - `RUN_` -> "run"
         - `TEXT_MESSAGE_` -> "text"
         - `TOOL_CALL_` -> "tool"
         - `THINKING_` -> "thinking"
         - Check for `tambo.component.` prefix -> "component"
         - Check for `tambo.run.` prefix -> "tool" (awaiting_input is tool-related)
         - Default -> "other"
       - `CATEGORY_COLORS` record mapping category to Tailwind badge classes:
         - run: "bg-blue-500", text: "bg-green-500", tool: "bg-orange-500", component: "bg-purple-500", thinking: "bg-gray-400", other: "bg-slate-400"
       - `summarizeEvent(eventType: string, payload: Record<string, unknown>): string` -- human-readable one-liner:
         - TEXT_MESSAGE_CONTENT: show truncated delta (first 50 chars)
         - TOOL_CALL_START: "Tool: {name}"
         - TOOL_CALL_ARGS: "Args chunk"
         - TOOL_CALL_END: "Tool call ended"
         - TOOL_CALL_RESULT: "Result received"
         - RUN_STARTED: "Run started"
         - RUN_FINISHED: "Run finished"
         - RUN_ERROR: "Error: {message truncated}"
         - Default: eventType as-is

    3. Create `use-devtools-events.ts`:
       - `useDevtoolsEvents(rawEvents, maxEvents = 5000)` hook that:
         - Takes raw stream events from `useDevtoolsConnection`
         - Maintains a `RingBuffer<TimelineEvent>` in a ref
         - Uses RAF batching: incoming events are pushed to buffer immediately, but React state only updates on animation frame
         - Returns `{ events: TimelineEvent[], droppedCount: number, clearEvents: () => void, selectedEvent: TimelineEvent | null, setSelectedEvent }`
         - Transforms raw events from connection hook format to `TimelineEvent` using `categorizeEvent` and `summarizeEvent`
         - Cleans up RAF on unmount

  </action>
  <verify>
    - `npm run check-types` passes
    - `npm run lint` passes
    - Create a simple test: `ring-buffer.test.ts` verifying push/toArray/droppedCount behavior with capacity overflow
  </verify>
  <done>Ring buffer, event categorizer, and RAF-batched hook are ready for UI consumption. RingBuffer has test coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Timeline panel UI with virtualized rendering and detail view</name>
  <files>
    apps/web/app/(authed)/devtools/components/timeline-panel.tsx
    apps/web/app/(authed)/devtools/components/timeline-event-row.tsx
    apps/web/app/(authed)/devtools/components/timeline-event-detail.tsx
    apps/web/app/(authed)/devtools/page.tsx
  </files>
  <action>
    1. Create `timeline-event-row.tsx`:
       - Memoized component (`React.memo`) with stable key on `seq`
       - Props: `event: TimelineEvent, isSelected: boolean, onSelect: (event: TimelineEvent) => void`
       - Layout: fixed height row (36px) with:
         - Color dot/badge (small circle using `CATEGORY_COLORS[event.category]`, 8px rounded-full)
         - Timestamp (formatted as HH:MM:SS.mmm using `new Date(event.timestamp).toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 })`)
         - Event type label (monospace, truncated)
         - Summary text (muted foreground, truncated with text-ellipsis)
       - Selected state: highlight background
       - Click handler calls onSelect

    2. Create `timeline-event-detail.tsx`:
       - Props: `event: TimelineEvent | null`
       - When null: "Select an event to view details" placeholder
       - When set: show event metadata (type, category, timestamp, threadId, seq) at top, then full JSON payload using the existing `JsonTreeViewer` component from the inspector
       - Import JsonTreeViewer from the existing Phase 2 component

    3. Create `timeline-panel.tsx`:
       - Props: `events: TimelineEvent[], droppedCount: number, selectedEvent: TimelineEvent | null, onSelectEvent: (event: TimelineEvent) => void, onClear: () => void`
       - Two-column layout: event list (left, scrollable) + detail panel (right)
       - Event list uses simple scroll-position-based virtualization:
         - Fixed row height (36px)
         - Calculate visible range from scrollTop and container height
         - Render only visible rows + small overscan (5 above and below)
         - Use absolute positioning or padding to maintain scroll height
       - Auto-scroll behavior:
         - Track whether user is "at bottom" (within 50px of scroll end)
         - If at bottom when new events arrive, auto-scroll to latest
         - If user scrolled up, stop auto-scrolling
         - Show a "Jump to latest" button (fixed at bottom) when not at bottom
       - Header bar with: event count, dropped count (if > 0 show "N events truncated"), and Clear button
       - If no events: "No events yet. Start streaming to see events appear here."

    4. Update `page.tsx`:
       - Import `TimelinePanel` and `useDevtoolsEvents`
       - Get `streamEvents` from `useDevtoolsConnection` return value
       - Pass current session's stream events to `useDevtoolsEvents`
       - Add a "Timeline" tab to the existing `Tabs` component (after "Registry")
       - Render `TimelinePanel` in the Timeline tab content
       - The timeline panel should have the same 600px height as the inspector panel

  </action>
  <verify>
    - `npm run check-types` passes
    - `npm run lint` passes
    - `npm run build -w apps/web` succeeds
    - Timeline tab appears in devtools page
    - Events render with color badges and timestamps
    - Clicking an event shows its full payload in the detail panel
  </verify>
  <done>Timeline panel renders color-coded events in real-time with virtualized scrolling, auto-scroll, and click-to-inspect detail view. Integrated into devtools page as a new tab.</done>
</task>

</tasks>

<verification>
- `npm run check-types` passes
- `npm run lint` passes
- `npm test` passes
- Timeline tab visible in devtools page
- Events are color-coded by category
- Click expands to full payload
- RingBuffer test passes
</verification>

<success_criteria>
STRM-01: Chronological timeline of AG-UI events visible in real-time. STRM-02: Events timestamped and color-coded by type. STRM-03: Click any event to see full payload. STRM-06: RAF batching + virtualization prevents jank with high-frequency events.
</success_criteria>

<output>
After completion, create `.planning/phases/03-streaming-visibility/03-02-SUMMARY.md`
</output>
