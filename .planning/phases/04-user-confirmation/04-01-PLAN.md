---
phase: 04-user-confirmation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - cli/src/utils/user-confirmation/types.ts
  - cli/src/utils/user-confirmation/diff-generator.ts
  - cli/src/utils/user-confirmation/diff-generator.test.ts
  - cli/src/utils/user-confirmation/diff-display.ts
  - cli/src/utils/user-confirmation/diff-display.test.ts
autonomous: true

must_haves:
  truths:
    - "Diff generator produces unified patch string for file modifications"
    - "Diff generator handles new file creation (no old content) gracefully"
    - "Diff display colorizes additions green, deletions red, context dim"
    - "PlanItem and ConfirmationResult types are defined and exported"
  artifacts:
    - path: "cli/src/utils/user-confirmation/types.ts"
      provides: "PlanItem, ConfirmationResult, ConfirmPlanOptions types"
      exports: ["PlanItem", "ConfirmationResult", "ConfirmPlanOptions"]
    - path: "cli/src/utils/user-confirmation/diff-generator.ts"
      provides: "generateFileDiff function"
      exports: ["generateFileDiff", "FileDiff"]
    - path: "cli/src/utils/user-confirmation/diff-display.ts"
      provides: "formatDiffForDisplay, displayFileDiff, displayNewFileMessage functions"
      exports:
        ["formatDiffForDisplay", "displayFileDiff", "displayNewFileMessage"]
  key_links:
    - from: "cli/src/utils/user-confirmation/diff-generator.ts"
      to: "diff"
      via: "createTwoFilesPatch import"
      pattern: "createTwoFilesPatch"
    - from: "cli/src/utils/user-confirmation/diff-display.ts"
      to: "chalk"
      via: "chalk color formatting"
      pattern: "chalk\\.(green|red|dim|cyan|bold)"
---

<objective>
Define confirmation types and implement diff generation/display utilities for the user confirmation flow.

Purpose: Provide the type foundation and diff primitives that the confirmation orchestrator (Plan 02) will compose into the interactive approval flow.
Output: Types file, diff generator with tests, diff display with tests.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@cli/src/utils/plan-generation/types.ts
@cli/src/utils/plan-generation/schemas.ts
@cli/src/utils/interactive.ts
@cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define confirmation types and implement diff generator with tests</name>
  <files>
    cli/src/utils/user-confirmation/types.ts
    cli/src/utils/user-confirmation/diff-generator.ts
    cli/src/utils/user-confirmation/diff-generator.test.ts
  </files>
  <action>
Create `cli/src/utils/user-confirmation/types.ts` with these types:

- `PlanItem`: `{ id: string; type: "provider" | "component" | "tool" | "interactable" | "chat-widget"; label: string; confidence: number; checked: boolean; disabled?: boolean | string }`
- `FileDiff`: `{ filePath: string; isNew: boolean; oldContent: string; newContent: string; patch: string }`
- `ConfirmationResult`: `{ approved: boolean; selectedItems: string[]; plan: InstallationPlan }` — import InstallationPlan from `../plan-generation/types.js`
- `ConfirmPlanOptions`: `{ yes?: boolean }`

Create `cli/src/utils/user-confirmation/diff-generator.ts`:

- Export `generateFileDiff(filePath: string, newContent: string): Promise<FileDiff>`
- Read existing file content with `fs.readFile`. If ENOENT, set `isNew: true` and `oldContent: ""`.
- For existing files: use `createTwoFilesPatch(filePath, filePath, oldContent, newContent, "Current", "After changes", { context: 3 })` from the `diff` package.
- For new files: set `patch` to empty string (caller should use `displayNewFileMessage` instead of showing diff).
- Re-throw non-ENOENT errors.

TDD: Write tests in `diff-generator.test.ts`:

- RED: Test that modifying an existing file produces a patch containing `+` and `-` lines. Test that a new file (ENOENT) returns `isNew: true` and empty patch. Test that non-ENOENT errors are re-thrown.
- GREEN: Implement to pass.
- Use real temp files (write to os.tmpdir) for the existing-file test case. For new-file test, use a path that doesn't exist.
  </action>
  <verify>Run `npm test -- --testPathPattern='diff-generator' -w cli` — all tests pass.</verify>
  <done>generateFileDiff produces correct unified patch for modifications, handles new files with isNew flag, and re-throws unexpected errors. All types exported.</done>
  </task>

<task type="auto">
  <name>Task 2: Implement diff display formatting with tests</name>
  <files>
    cli/src/utils/user-confirmation/diff-display.ts
    cli/src/utils/user-confirmation/diff-display.test.ts
  </files>
  <action>
Create `cli/src/utils/user-confirmation/diff-display.ts`:

- Export `formatDiffForDisplay(patch: string): string` — Split patch by newlines, colorize each line:
  - `@@` lines → `chalk.cyan`
  - `---` / `+++` lines → `chalk.bold.dim`
  - `+` lines → `chalk.green`
  - `-` lines → `chalk.red`
  - Context lines → `chalk.dim`
  - `Index:` / `===` lines → `chalk.bold`

- Export `displayFileDiff(diff: FileDiff): void` — Print file path header with `chalk.bold`, then print `formatDiffForDisplay(diff.patch)`. Import `FileDiff` from `./types.js`.

- Export `displayNewFileMessage(filePath: string, lineCount: number): void` — Print `chalk.green("+ Will create")` followed by `chalk.bold(filePath)` and `chalk.dim(`(${lineCount} lines)`)`.

TDD: Write tests in `diff-display.test.ts`:

- RED: Test formatDiffForDisplay with a sample patch string. Verify output contains chalk escape codes for green (additions), red (deletions), cyan (hunk headers). Use `chalk.level = 1` in beforeAll to force color output in tests.
- RED: Test displayNewFileMessage outputs correct message (mock console.log, verify called with expected content).
- GREEN: Implement to pass.
  </action>
  <verify>Run `npm test -- --testPathPattern='diff-display' -w cli` — all tests pass.</verify>
  <done>formatDiffForDisplay colorizes unified diffs correctly. displayFileDiff and displayNewFileMessage produce readable terminal output. All functions exported.</done>
  </task>

</tasks>

<verification>
```bash
npm test -- --testPathPattern='user-confirmation' -w cli
npm run check-types -w cli
npm run lint -w cli
```
All pass with no errors.
</verification>

<success_criteria>

- Types file exports PlanItem, ConfirmationResult, ConfirmPlanOptions, FileDiff
- generateFileDiff works for both existing and new files
- formatDiffForDisplay produces colored output for unified diffs
- displayNewFileMessage handles new file case cleanly
- All tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/04-user-confirmation/04-01-SUMMARY.md`
</output>
