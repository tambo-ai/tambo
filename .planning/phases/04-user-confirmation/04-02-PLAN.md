---
phase: 04-user-confirmation
plan: 02
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - cli/src/utils/user-confirmation/plan-presenter.ts
  - cli/src/utils/user-confirmation/plan-presenter.test.ts
  - cli/src/utils/user-confirmation/index.ts
  - cli/src/utils/user-confirmation/index.test.ts
autonomous: true

must_haves:
  truths:
    - "CLI presents plan as batch checklist with pre-selected high-confidence items"
    - "Provider setup is required and cannot be deselected"
    - "User can select/deselect individual items and confirm selection"
    - "CLI shows unified diffs for modified files and creation messages for new files"
    - "Non-interactive mode with --yes auto-approves items with confidence >= 0.8"
    - "Non-interactive mode without --yes throws NonInteractiveError with guidance"
  artifacts:
    - path: "cli/src/utils/user-confirmation/plan-presenter.ts"
      provides: "planToCheckboxItems conversion and displayPlanSummary"
      exports: ["planToCheckboxItems", "displayPlanSummary"]
    - path: "cli/src/utils/user-confirmation/index.ts"
      provides: "confirmPlan orchestrator function"
      exports: ["confirmPlan", "ConfirmationResult", "ConfirmPlanOptions"]
  key_links:
    - from: "cli/src/utils/user-confirmation/plan-presenter.ts"
      to: "cli/src/utils/plan-generation/types.ts"
      via: "InstallationPlan import"
      pattern: "InstallationPlan"
    - from: "cli/src/utils/user-confirmation/index.ts"
      to: "@inquirer/prompts"
      via: "checkbox and confirm imports"
      pattern: "(checkbox|confirm).*@inquirer/prompts"
    - from: "cli/src/utils/user-confirmation/index.ts"
      to: "cli/src/utils/interactive.ts"
      via: "isInteractive, NonInteractiveError imports"
      pattern: "isInteractive|NonInteractiveError"
    - from: "cli/src/utils/user-confirmation/index.ts"
      to: "cli/src/utils/user-confirmation/diff-generator.ts"
      via: "generateFileDiff for real unified diffs"
      pattern: "generateFileDiff"
    - from: "cli/src/utils/user-confirmation/index.ts"
      to: "cli/src/utils/user-confirmation/content-generator.ts"
      via: "generateContentForRecommendation to produce full file content for diffs"
      pattern: "generateContentForRecommendation"
---

<objective>
Build the plan presenter (checklist conversion) and confirmPlan orchestrator that ties together checklist selection, diff display, and final confirmation.

Purpose: Complete the user confirmation flow so Phase 5 receives an approved, filtered InstallationPlan.
Output: Plan presenter with tests, confirmPlan orchestrator with tests, barrel index exporting public API.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-user-confirmation/04-01-SUMMARY.md
@cli/src/utils/plan-generation/types.ts
@cli/src/utils/plan-generation/schemas.ts
@cli/src/utils/interactive.ts
@cli/src/utils/user-confirmation/types.ts
@cli/src/utils/user-confirmation/diff-generator.ts
@cli/src/utils/user-confirmation/diff-display.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement plan presenter (plan-to-checklist conversion) with tests</name>
  <files>
    cli/src/utils/user-confirmation/plan-presenter.ts
    cli/src/utils/user-confirmation/plan-presenter.test.ts
  </files>
  <action>
Create `cli/src/utils/user-confirmation/plan-presenter.ts`:

- Export `planToCheckboxItems(plan: InstallationPlan): PlanItem[]` — Converts InstallationPlan to checkbox items:
  - Provider setup: `{ id: "provider-setup", type: "provider", label: "Add TamboProvider to <filePath>", confidence: plan.providerSetup.confidence, checked: true, disabled: "(required)" }`
  - Each componentRecommendation: `{ id: "component-<idx>", type: "component", label: "Register <name> component (<confidence>%)", confidence, checked: confidence >= 0.8 }`
  - Each toolRecommendation: `{ id: "tool-<idx>", type: "tool", label: "Create <name> tool from <type> (<confidence>%)", confidence, checked: confidence >= 0.8 }`
  - Each interactableRecommendation: `{ id: "interactable-<idx>", type: "interactable", label: "Add interactability to <componentName> (<confidence>%)", confidence, checked: confidence >= 0.8 }`
  - Chat widget: `{ id: "chat-widget", type: "chat-widget", label: "Add chat widget to <filePath>", confidence: plan.chatWidgetSetup.confidence, checked: plan.chatWidgetSetup.confidence >= 0.8 }`
  - Confidence percentage in label: `Math.round(confidence * 100)`

- Export `displayPlanSummary(plan: InstallationPlan): void` — Print summary header showing count of items per category and average confidence. Use chalk for formatting. Keep it simple — no cli-table3, just formatted lines with chalk.bold for headers and chalk.dim for counts.

- Export `filterPlanBySelection(plan: InstallationPlan, selectedIds: string[]): InstallationPlan` — Returns a new InstallationPlan with only the items whose ids are in selectedIds. Provider setup is always included. Filter componentRecommendations, toolRecommendations, interactableRecommendations arrays by matching index to id pattern. Chat widget included only if "chat-widget" in selectedIds.

TDD: Write tests in `plan-presenter.test.ts`:

- RED: Test planToCheckboxItems with a mock InstallationPlan — verify provider is always disabled and checked, high-confidence items are pre-checked, low-confidence items are not checked.
- RED: Test filterPlanBySelection — verify only selected items remain, provider always included.
- GREEN: Implement to pass.

For mock InstallationPlan, create a test fixture with 2 components (one 0.9 confidence, one 0.5), 1 tool (0.85), 1 interactable (0.6), provider (0.95), chat widget (0.9).
</action>
<verify>Run `npm test -- --testPathPattern='plan-presenter' -w cli` — all tests pass.</verify>
<done>planToCheckboxItems correctly maps InstallationPlan to PlanItem array with proper pre-selection logic. filterPlanBySelection returns filtered plan. displayPlanSummary prints readable summary.</done>
</task>

<task type="auto">
  <name>Task 2: Implement confirmPlan orchestrator with tests</name>
  <files>
    cli/src/utils/user-confirmation/index.ts
    cli/src/utils/user-confirmation/index.test.ts
  </files>
  <action>
Create `cli/src/utils/user-confirmation/index.ts`:

- Re-export types: `export type { ConfirmationResult, ConfirmPlanOptions, PlanItem, FileDiff } from "./types.js"`
- Re-export utilities: `export { generateFileDiff } from "./diff-generator.js"`, `export { formatDiffForDisplay, displayFileDiff, displayNewFileMessage } from "./diff-display.js"`, `export { planToCheckboxItems, displayPlanSummary, filterPlanBySelection } from "./plan-presenter.js"`

- Export `confirmPlan(plan: InstallationPlan, options: ConfirmPlanOptions = {}): Promise<ConfirmationResult>`:

  **Non-interactive path** (`options.yes` or `!isInteractive()`):
  - If `!options.yes && !isInteractive()`: throw `NonInteractiveError` with message explaining `--yes` flag usage (follow pattern from interactive.ts).
  - If `options.yes`: auto-approve by selecting all items with `confidence >= 0.8` plus provider-setup (always). Return `{ approved: true, selectedItems, plan: filterPlanBySelection(plan, selectedIds) }`.

  **Interactive path:**
  1. Call `displayPlanSummary(plan)`.
  2. Convert plan to items via `planToCheckboxItems(plan)`.
  3. Map PlanItem[] to `@inquirer/prompts` checkbox choices: `{ value: item.id, name: item.label, checked: item.checked, disabled: item.disabled || false }`.
  4. Call `checkbox({ message: "Select changes to apply:", choices, required: true })` from `@inquirer/prompts`.
  5. Generate real unified diffs for selected items using `generateContentForRecommendation` (from `./content-generator.js`) + `generateFileDiff` (from `./diff-generator.js`):
     - For each selected item, determine its type and filePath from the plan.
     - Read the existing file content via `fs.readFile` (empty string if ENOENT for new files like tools).
     - Call `generateContentForRecommendation({ type, filePath, plan }, existingContent)` to get the full modified content.
     - Call `generateFileDiff(filePath, newContent)` to produce the unified diff.
     - For new files (`diff.isNew`), call `displayNewFileMessage(filePath, newContent.split('\n').length)`.
     - For modifications, call `displayFileDiff(diff)`.
  6. Call `confirm({ message: "Apply selected changes?", default: true })` from `@inquirer/prompts`.
  7. If not confirmed: return `{ approved: false, selectedItems: [], plan }`.
  8. If confirmed: return `{ approved: true, selectedItems: selectedIds, plan: filterPlanBySelection(plan, selectedIds) }`.

TDD: Write tests in `index.test.ts`:

- RED: Test non-interactive without --yes throws NonInteractiveError.
- RED: Test --yes mode auto-approves high-confidence items and returns filtered plan.
- RED: Test --yes mode always includes provider-setup regardless of confidence.
- GREEN: Implement to pass.

For the --yes tests, mock `isInteractive` to return false. Don't test the interactive path with mocked inquirer — that's integration testing territory.
</action>
<verify>Run `npm test -- --testPathPattern='user-confirmation/index' -w cli` — all tests pass. Then run full suite: `npm test -w cli && npm run check-types -w cli && npm run lint -w cli`.</verify>
<done>confirmPlan orchestrator handles both interactive and non-interactive flows. --yes flag auto-approves high-confidence items. NonInteractiveError thrown when appropriate. ConfirmationResult returned with filtered plan for Phase 5.</done>
</task>

</tasks>

<verification>
```bash
npm test -- --testPathPattern='user-confirmation' -w cli
npm run check-types -w cli
npm run lint -w cli
```
All pass with no errors.
</verification>

<success_criteria>

- confirmPlan returns ConfirmationResult with filtered plan
- --yes flag auto-approves items with confidence >= 0.8
- Provider setup always included in auto-approval
- NonInteractiveError thrown in non-interactive mode without --yes
- Interactive mode presents checklist, shows change summaries, gets final confirmation
- All tests pass, types check, lint clean
  </success_criteria>

<output>
After completion, create `.planning/phases/04-user-confirmation/04-02-SUMMARY.md`
</output>
