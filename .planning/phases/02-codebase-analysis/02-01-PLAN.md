---
phase: 02-codebase-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cli/src/utils/project-analysis/types.ts
  - cli/src/utils/project-analysis/framework-detection.ts
  - cli/src/utils/project-analysis/framework-detection.test.ts
  - cli/src/utils/project-analysis/structure-detection.ts
  - cli/src/utils/project-analysis/structure-detection.test.ts
  - cli/src/utils/project-analysis/fs-helpers.ts
  - cli/src/utils/project-analysis/fs-helpers.test.ts
autonomous: true
must_haves:
  truths:
    - "CLI correctly identifies Next.js (App Router vs Pages Router), Vite, Remix, and CRA from project files"
    - "CLI detects TypeScript vs JavaScript configuration"
    - "CLI detects project structure patterns (src/, app/, pages/, components/)"
    - "CLI locates root layout files based on detected framework"
    - "CLI detects package manager in use (npm, yarn, pnpm, bun)"
  artifacts:
    - path: "cli/src/utils/project-analysis/types.ts"
      provides: "ProjectAnalysis, FrameworkInfo, ProjectStructure, TypeScriptInfo interfaces"
      exports:
        [
          "FrameworkInfo",
          "FrameworkName",
          "NextJsVariant",
          "ProjectStructure",
          "TypeScriptInfo",
          "ProjectAnalysis",
        ]
    - path: "cli/src/utils/project-analysis/framework-detection.ts"
      provides: "Extended framework detection with Remix, CRA, Next.js variant detection"
      exports: ["detectFrameworkInfo"]
    - path: "cli/src/utils/project-analysis/structure-detection.ts"
      provides: "Project structure and root layout detection"
      exports: ["detectProjectStructure", "detectTypeScriptConfig"]
    - path: "cli/src/utils/project-analysis/fs-helpers.ts"
      provides: "Shared filesystem utilities (findFilesRecursively, findFirstExisting, findDirectory)"
      exports: ["findFilesRecursively", "findFirstExisting", "findDirectory"]
  key_links:
    - from: "cli/src/utils/project-analysis/framework-detection.ts"
      to: "cli/src/utils/project-analysis/types.ts"
      via: "imports FrameworkInfo type"
      pattern: "import.*FrameworkInfo.*from.*types"
    - from: "cli/src/utils/project-analysis/structure-detection.ts"
      to: "cli/src/utils/project-analysis/framework-detection.ts"
      via: "uses FrameworkInfo to determine root layout location"
      pattern: "FrameworkInfo"
---

<objective>
Create the foundational types and filesystem-based detection modules for project analysis: framework detection (extended beyond existing to include Remix, CRA, Next.js App/Pages Router variant), project structure detection, TypeScript config detection, and shared filesystem helpers.

Purpose: These are the non-AST building blocks that the rest of codebase analysis depends on. Framework and structure detection inform where to look for providers, components, and tools.
Output: Types, framework detection, structure detection, and fs helpers in cli/src/utils/project-analysis/
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-codebase-analysis/02-RESEARCH.md
@cli/src/utils/framework-detection.ts
@cli/src/utils/package-manager.ts
@cli/AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, fs-helpers, and framework detection</name>
  <files>
    cli/src/utils/project-analysis/types.ts
    cli/src/utils/project-analysis/fs-helpers.ts
    cli/src/utils/project-analysis/fs-helpers.test.ts
    cli/src/utils/project-analysis/framework-detection.ts
    cli/src/utils/project-analysis/framework-detection.test.ts
  </files>
  <action>
Create cli/src/utils/project-analysis/ directory with:

**types.ts** - Core interfaces for the entire analysis module:

- `FrameworkName`: union type `"next" | "vite" | "remix" | "cra" | "unknown"`
- `NextJsVariant`: `"next-app-router" | "next-pages-router"`
- `FrameworkInfo`: `{ name: FrameworkName; variant?: NextJsVariant; displayName: string; envPrefix: string | null }`
- `TypeScriptInfo`: `{ isTypeScript: boolean; configPath: string | null; strict: boolean | null }`
- `ProjectStructure`: `{ hasSrcDir: boolean; srcPath: string | null; appDirPath: string | null; pagesDirPath: string | null; componentsDirs: string[]; rootLayoutPath: string | null }`
- `ProviderInfo`: `{ name: string; importSource: string; filePath: string; nestingLevel: number }`
- `ComponentInfo`: `{ name: string; filePath: string; isExported: boolean; hasProps: boolean; propsInterface?: string; hooks: string[] }`
- `ToolCandidate`: `{ name: string; filePath: string; type: "fetch" | "axios" | "server-action" | "exported-function"; description?: string }`
- `ProjectAnalysis`: `{ framework: FrameworkInfo; structure: ProjectStructure; typescript: TypeScriptInfo; packageManager: string; providers: ProviderInfo[]; components: ComponentInfo[]; toolCandidates: ToolCandidate[] }`

**fs-helpers.ts** - Shared filesystem utilities:

- `findFilesRecursively(dir, extensions, options?: { exclude?: string[] })`: Walk directories recursively, skip node_modules/.next/dist/build/.git by default. Return absolute paths.
- `findFirstExisting(candidates, root)`: Check list of relative paths, return first that exists (absolute), or null.
- `findDirectory(candidates, root)`: Like findFirstExisting but for directories.
- Use `fs.readdirSync` with `{ withFileTypes: true }` for efficient traversal.
- Always use `path.join()` for cross-platform compatibility.

**fs-helpers.test.ts** - Test with memfs (follow existing CLI test patterns using vol.fromJSON):

- Test findFilesRecursively finds .ts/.tsx files, excludes node_modules
- Test findFirstExisting returns first match or null
- Test findDirectory returns first existing directory or null

**framework-detection.ts** - Extended framework detection (NEW module, does NOT modify existing cli/src/utils/framework-detection.ts):

- `detectFrameworkInfo(projectRoot: string): FrameworkInfo`
- Detection priority order (config files first, then deps as research recommends):
  1. Next.js: check for next in deps OR next.config.{js,ts,mjs}. If detected, call `detectNextJsVariant()` which checks for app/layout.tsx (or src/app/layout.tsx) to distinguish App Router vs Pages Router. App Router takes precedence if both exist.
  2. Vite: check for vite in deps OR vite.config.{ts,js,mjs}
  3. Remix: check for @remix-run/react in deps
  4. CRA: check for react-scripts in deps (lowest priority per research - CRA is deprecated)
  5. Return `{ name: "unknown", displayName: "Unknown", envPrefix: null }` if none match
- Parse package.json once, pass deps object to each check. Use try/catch for missing package.json, return "unknown" framework.
- This is a NEW function in a NEW location (project-analysis module). The existing cli/src/utils/framework-detection.ts is used by other CLI commands and should NOT be modified.

**framework-detection.test.ts** - Test all framework variants:

- Next.js App Router (has next dep + app/layout.tsx)
- Next.js Pages Router (has next dep + pages/\_app.tsx, no app/layout.tsx)
- Vite (has vite dep)
- Remix (has @remix-run/react dep)
- CRA (has react-scripts dep)
- Unknown (empty deps)
- Priority: Next.js detected over CRA when both present
- Use memfs to mock filesystem
  </action>
  <verify>
  Run `npm test -w cli -- --testPathPattern="project-analysis/(fs-helpers|framework-detection)"` and all tests pass.
  Run `npm run check-types -w cli` with no errors.
  </verify>
  <done>
  Framework detection correctly identifies all 5 framework variants (Next.js App/Pages, Vite, Remix, CRA) with proper priority ordering. Filesystem helpers work cross-platform. All tests pass.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Structure detection and TypeScript config detection</name>
  <files>
    cli/src/utils/project-analysis/structure-detection.ts
    cli/src/utils/project-analysis/structure-detection.test.ts
  </files>
  <action>
**structure-detection.ts**:
- `detectProjectStructure(projectRoot: string, framework: FrameworkInfo): ProjectStructure`
  - Check for src/ directory existence
  - Find app/ and pages/ directories (check both root and src/ prefixed)
  - Find all components/ directories by walking project (use findFilesRecursively logic but for dirs, or a separate findComponentsDirs helper). Skip node_modules, .next, dist, build, .git.
  - Locate root layout file based on framework:
    - next-app-router: app/layout.tsx, app/layout.jsx, src/app/layout.tsx, src/app/layout.jsx
    - next-pages-router: pages/_app.tsx, pages/_app.jsx, src/pages/_app.tsx, src/pages/_app.jsx
    - vite: src/App.tsx, src/App.jsx, App.tsx, App.jsx
    - remix: app/root.tsx, app/root.jsx
    - cra: src/App.tsx, src/App.jsx
    - unknown: try common patterns (src/App.tsx, App.tsx)
  - Use findFirstExisting from fs-helpers for candidate checking.

- `detectTypeScriptConfig(projectRoot: string): TypeScriptInfo`
  - Check for tsconfig.json existence
  - If exists, parse it and check compilerOptions.strict
  - Return `{ isTypeScript: true/false, configPath: absolute path or null, strict: boolean or null }`
  - Use try/catch for JSON parse errors (tsconfig can have comments - strip them or use a lenient approach). Simplest: read file, strip single-line comments with regex `//.*$` per line, then JSON.parse. If that fails, just return `{ isTypeScript: true, configPath, strict: null }`.

**structure-detection.test.ts**:

- Test Next.js App Router structure (src/app/layout.tsx found)
- Test Next.js Pages Router structure (pages/\_app.tsx found)
- Test Vite structure (src/App.tsx found)
- Test Remix structure (app/root.tsx found)
- Test TypeScript detection (tsconfig.json present with strict: true)
- Test JavaScript project (no tsconfig.json)
- Test components/ directory discovery
- Use memfs
  </action>
  <verify>
  Run `npm test -w cli -- --testPathPattern="project-analysis/structure-detection"` and all tests pass.
  Run `npm run check-types -w cli` with no errors.
  </verify>
  <done>
  Structure detection correctly finds root layout files for all framework variants. TypeScript config detection reads tsconfig.json and reports strict mode. Components directories are discovered. All tests pass.
  </done>
  </task>

</tasks>

<verification>
- `npm test -w cli -- --testPathPattern="project-analysis"` — all tests pass
- `npm run check-types -w cli` — no type errors
- `npm run lint -w cli` — no lint errors
</verification>

<success_criteria>

- FrameworkInfo correctly returned for Next.js (both variants), Vite, Remix, CRA, and unknown
- ProjectStructure correctly locates root layout for each framework
- TypeScriptInfo correctly detects TS config and strict mode
- Filesystem helpers handle edge cases (missing dirs, empty dirs)
- All functions are pure (read-only, no side effects beyond fs reads)
- Tests use memfs, no real filesystem access
  </success_criteria>

<output>
After completion, create `.planning/phases/02-codebase-analysis/02-01-SUMMARY.md`
</output>
