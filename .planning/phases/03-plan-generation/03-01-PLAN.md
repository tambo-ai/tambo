---
phase: 03-plan-generation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - cli/src/utils/plan-generation/types.ts
  - cli/src/utils/plan-generation/schemas.ts
  - cli/src/utils/plan-generation/schemas.test.ts
  - cli/src/utils/plan-generation/prompt-builder.ts
  - cli/src/utils/plan-generation/prompt-builder.test.ts
autonomous: true

must_haves:
  truths:
    - "InstallationPlan type accurately represents all recommendation categories"
    - "Zod schemas validate model output and reject malformed plans"
    - "Prompt builder converts ProjectAnalysis into a structured prompt string"
  artifacts:
    - path: "cli/src/utils/plan-generation/types.ts"
      provides: "InstallationPlan and recommendation types"
    - path: "cli/src/utils/plan-generation/schemas.ts"
      provides: "Zod schemas for plan validation"
      exports: ["installationPlanSchema"]
    - path: "cli/src/utils/plan-generation/prompt-builder.ts"
      provides: "ProjectAnalysis to prompt conversion"
      exports: ["buildPlanPrompt"]
  key_links:
    - from: "cli/src/utils/plan-generation/schemas.ts"
      to: "cli/src/utils/plan-generation/types.ts"
      via: "z.infer produces InstallationPlan type"
      pattern: "z\\.infer<typeof installationPlanSchema>"
    - from: "cli/src/utils/plan-generation/prompt-builder.ts"
      to: "cli/src/utils/project-analysis/types.ts"
      via: "accepts ProjectAnalysis as input"
      pattern: "ProjectAnalysis"
---

<objective>
Define the InstallationPlan data model, Zod validation schemas, and prompt builder that converts Phase 2's ProjectAnalysis into a structured LLM prompt.

Purpose: Establish the type system and prompt engineering foundation that Plan 02's orchestrator will use to generate and validate installation plans.
Output: types.ts, schemas.ts (with tests), prompt-builder.ts (with tests)
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-plan-generation/03-RESEARCH.md
@cli/src/utils/project-analysis/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: InstallationPlan types and Zod schemas with validation tests</name>
  <files>
    cli/src/utils/plan-generation/types.ts
    cli/src/utils/plan-generation/schemas.ts
    cli/src/utils/plan-generation/schemas.test.ts
  </files>
  <action>
Create `cli/src/utils/plan-generation/types.ts` with these types (derive from Zod schemas via `z.infer`):

- `ProviderSetupRecommendation`: filePath (string), nestingLevel (int >= 0), rationale (string min 10 chars), confidence (number 0-1)
- `ComponentRecommendation`: name, filePath, reason (min 10), confidence, suggestedRegistration (code snippet string)
- `ToolRecommendation`: name, type (enum: "server-action" | "fetch" | "axios" | "exported-function"), filePath, reason (min 10), confidence, suggestedSchema (Zod schema snippet string)
- `InteractableRecommendation`: componentName, filePath, reason (min 10), confidence, integrationPattern (description string)
- `ChatWidgetSetup`: filePath, position (enum: "bottom-right" | "bottom-left" | "top-right" | "sidebar"), rationale (min 10), confidence
- `InstallationPlan`: providerSetup (ProviderSetupRecommendation), componentRecommendations (array), toolRecommendations (array), interactableRecommendations (array), chatWidgetSetup (ChatWidgetSetup)

Create `cli/src/utils/plan-generation/schemas.ts`:

- Define all Zod schemas matching the types above
- Export `installationPlanSchema` as the root schema
- Export individual sub-schemas for testing
- Types in types.ts should be derived via `z.infer<typeof schema>` (import schemas, export inferred types)

Create `cli/src/utils/plan-generation/schemas.test.ts` (TDD - write tests RED first):

- Valid complete plan parses successfully
- Missing required fields rejected (providerSetup, chatWidgetSetup)
- Confidence out of range (negative, >1) rejected
- Invalid position enum rejected
- Invalid tool type enum rejected
- Rationale/reason too short (<10 chars) rejected
- Empty arrays for recommendations are valid
- Extra fields stripped (Zod strict or strip behavior)
  </action>
  <verify>
  Run: `npm test -- --testPathPattern="plan-generation/schemas" --no-coverage` from cli/
  All schema tests pass.
  Run: `npm run check-types` from root to confirm types compile.
  </verify>
  <done>
  Zod schemas validate well-formed InstallationPlan objects and reject malformed ones. Types are inferred from schemas.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Prompt builder with tests</name>
  <files>
    cli/src/utils/plan-generation/prompt-builder.ts
    cli/src/utils/plan-generation/prompt-builder.test.ts
  </files>
  <action>
Create `cli/src/utils/plan-generation/prompt-builder.ts`:
- Export `buildPlanPrompt(analysis: ProjectAnalysis): string`
- Build structured prompt with these sections:
  1. System context: "You are analyzing a {framework} project to generate a Tambo installation plan"
  2. Project context: framework, TypeScript config, package manager, structure
  3. Existing providers (all, with name and import source)
  4. Components (top 10 most relevant, with props/hooks info). If >10, note "and N more"
  5. Tool candidates (top 10, with type and description). If >10, note "and N more"
  6. Task description: what to generate (5 recommendation categories)
  7. Output format: JSON structure matching installationPlanSchema (include example field names)
  8. Quality guidance: "Only recommend high-confidence items (>0.7) unless explicitly valuable", "Prioritize user-facing components", "Reference specific files in rationale"
  9. IMPORTANT instruction: "Output ONLY valid JSON, no additional text or markdown code blocks"
- Keep prompt under ~4000 tokens estimated (rough: count chars / 4)
- Handle edge cases: empty providers array, empty components, empty tool candidates

Create `cli/src/utils/plan-generation/prompt-builder.test.ts`:

- Prompt includes framework display name
- Prompt includes TypeScript strict mode info
- Prompt includes package manager
- Prompt lists providers with names and import sources
- Prompt limits components to 10 and shows "and N more" when >10
- Prompt limits tool candidates to 10 and shows "and N more" when >10
- Prompt handles empty providers/components/tools gracefully (no "undefined" or crashes)
- Prompt includes JSON output format instruction
- Prompt includes "ONLY valid JSON" instruction
  </action>
  <verify>
  Run: `npm test -- --testPathPattern="plan-generation/prompt-builder" --no-coverage` from cli/
  All prompt builder tests pass.
  </verify>
  <done>
  buildPlanPrompt converts any ProjectAnalysis into a well-structured prompt string suitable for LLM consumption.
  </done>
  </task>

</tasks>

<verification>
```bash
cd cli && npm test -- --testPathPattern="plan-generation" --no-coverage
cd .. && npm run check-types
cd cli && npm run lint
```
All tests pass, types compile, lint clean.
</verification>

<success_criteria>

- InstallationPlan type system fully defined with Zod validation
- Schema tests prove validation accepts good data and rejects bad data
- Prompt builder converts ProjectAnalysis â†’ prompt string with all required sections
- Prompt builder tests prove correct formatting and edge case handling
  </success_criteria>

<output>
After completion, create `.planning/phases/03-plan-generation/03-01-SUMMARY.md`
</output>
