---
phase: 04-devtools-trigger-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - react-sdk/src/devtools/devtools-trigger.tsx
  - react-sdk/src/devtools/tambo-dev-tools.tsx
autonomous: true
requirements: [WIRE-01, TRIG-01, TRIG-02, TRIG-03, TRIG-04, TRIG-05]

must_haves:
  truths:
    - "Trigger renders as a minimal green/gray dot, not a circle with T letter"
    - "Clicking dot opens popover showing component count, tool count, thread count, active thread, streaming status"
    - "Error count badge appears on the dot when errors exist"
    - "Open DevTools button opens correct dashboard URL (port 8260, not 8265) with clientId query param"
    - "Trigger position is configurable via prop, defaults to bottom-right"
    - "Trigger is not mounted on /devtools page (verified by layout exclusion)"
  artifacts:
    - path: "react-sdk/src/devtools/devtools-trigger.tsx"
      provides: "Redesigned trigger with dot, popover stats, dashboard link"
      contains: "SummaryStats"
    - path: "react-sdk/src/devtools/tambo-dev-tools.tsx"
      provides: "Stats computation and dashboard URL derivation passed to trigger"
      contains: "deriveDashboardUrl"
  key_links:
    - from: "react-sdk/src/devtools/tambo-dev-tools.tsx"
      to: "react-sdk/src/devtools/devtools-trigger.tsx"
      via: "props: stats, dashboardUrl, isConnected"
      pattern: "TamboDevToolsTrigger.*stats.*dashboardUrl"
    - from: "react-sdk/src/devtools/devtools-trigger.tsx"
      to: "/devtools?clientId="
      via: "window.open with derived URL"
      pattern: "window\\.open.*dashboardUrl"
---

<objective>
Redesign the devtools trigger as a minimal dot with stats popover and correct dashboard linking.

Purpose: The current trigger shows a "T" circle, links to the WS port (wrong), and shows no useful stats. This plan fixes all trigger UI issues and wires stats from TamboDevTools.
Output: Fully functional trigger with dot indicator, stats popover, error badge, and correct dashboard URL.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-devtools-trigger-fix/04-CONTEXT.md
@.planning/phases/04-devtools-trigger-fix/04-RESEARCH.md
@react-sdk/src/devtools/devtools-trigger.tsx
@react-sdk/src/devtools/tambo-dev-tools.tsx
@react-sdk/src/devtools/devtools-protocol.ts
@react-sdk/src/devtools/devtools-bridge.ts
@apps/web/app/(authed)/devtools/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign trigger component with dot, stats popover, and dashboard link</name>
  <files>react-sdk/src/devtools/devtools-trigger.tsx</files>
  <action>
Completely rewrite the TamboDevToolsTrigger component:

1. **Update props interface** to `TamboDevToolsTriggerProps`:
   - `isConnected: boolean`
   - `stats: SummaryStats` (new interface: `{ componentCount: number; toolCount: number; threadCount: number; activeThread?: string; isStreaming: boolean; errorCount: number }`)
   - `dashboardUrl: string`
   - `position?: { bottom?: number; right?: number; top?: number; left?: number }` (defaults to `{ bottom: 16, right: 16 }`)

2. **Trigger button**: Replace the 40px circle-with-T with:
   - 48px transparent click target button (not div), `position: fixed`, configurable via position prop
   - 12px dot centered inside, `borderRadius: '50%'`
   - Dot color: `#22c55e` (Tambo green) when connected, `#6b7280` (gray) when disconnected
   - Error badge on the dot: absolute positioned red circle (`#ef4444`) with error count, white text, only shown when `stats.errorCount > 0`
   - `zIndex: 9999`, `overflow: 'visible'` on button
   - Proper `aria-label="Tambo DevTools"`, use `<button>` element

3. **Popover** (shown on click, toggled via `isOpen` state):
   - Fixed position, anchored relative to trigger (bottom: 72, right: 16 — adjust based on position prop)
   - Dark theme: `backgroundColor: '#1a1a2e'`, `border: '1px solid #2a2a4a'`, `borderRadius: 8`, `padding: 16`
   - Header: "Tambo DevTools" (fontWeight 600, fontSize 14)
   - Connection status row: 8px colored dot + "Connected"/"Disconnected" text
   - Stats grid (2-column: label + value): Components, Tools, Threads counts
   - Active thread name (only if `stats.activeThread` exists)
   - Streaming status: "Yes"/"No"
   - "Open DevTools" button: full width, purple (`#7c3aed`), calls `window.open(dashboardUrl, '_blank')` — standard `_blank`, NOT named window, NO `noopener,noreferrer` third arg

4. **All inline styles** — no Tailwind, no CSS imports. This is an SDK component.

5. **Export**: Keep as default export for backward compat. Also add named export `TamboDevToolsTrigger`. Export the `SummaryStats` interface.
   </action>
   <verify>Run `npm run check-types -w react-sdk` — no type errors in devtools-trigger.tsx</verify>
   <done>Trigger renders as minimal dot with stats popover and correct "Open DevTools" linking to dashboardUrl prop</done>
   </task>

<task type="auto">
  <name>Task 2: Wire stats computation and dashboard URL derivation in TamboDevTools</name>
  <files>react-sdk/src/devtools/tambo-dev-tools.tsx</files>
  <action>
Update TamboDevTools to compute stats from snapshot data and derive dashboard URL, passing both to the trigger:

1. **Import `SummaryStats`** from `./devtools-trigger`.

2. **Add `deriveDashboardUrl` function** (module-level, not exported):

   ```
   function deriveDashboardUrl(wsHost: string, wsPort: number, sessionId: string): string {
     const DASHBOARD_PORT = 8260;
     const url = new URL(`http://${wsHost}:${DASHBOARD_PORT}/devtools`);
     url.searchParams.set("clientId", sessionId);
     return url.toString();
   }
   ```

3. **Add `getStatsFromSnapshot` function** (module-level) that computes `SummaryStats` from current registry and stream state:
   - `componentCount`: `registry.componentList.length`
   - `toolCount`: `registry.toolRegistry.length`
   - `threadCount`: count threads from `streamState?.threadMap` (Object.keys length, or 0)
   - `activeThread`: find a thread with streaming status from threadMap, return its name/id
   - `isStreaming`: whether any thread is streaming
   - `errorCount`: 0 for now (no error tracking in current snapshot structure — leave as 0, can be wired later)

4. **Compute stats with useMemo** depending on registry and streamState.

5. **Compute dashboardUrl with useMemo** depending on host, port, sessionIdRef.

6. **Update the return JSX** to pass new props to TamboDevToolsTrigger:
   ```tsx
   return (
     <TamboDevToolsTrigger
       isConnected={isConnected}
       stats={stats}
       dashboardUrl={dashboardUrl}
     />
   );
   ```
   Remove the `port` prop — trigger no longer needs it directly.

Note: The TamboDevTools component in apps/web/providers/tambo-provider.tsx already renders correctly (line 66: `<TamboDevTools />`). WIRE-01 is satisfied by existing code — it connects to WS bridge and sends snapshots. TRIG-03 is satisfied because /devtools layout.tsx does not include TamboProviderWrapper.
</action>
<verify>Run `npm run check-types -w react-sdk` and `npm run build -w react-sdk` — both pass with no errors</verify>
<done>TamboDevTools computes stats from registry/stream state and derives dashboard URL, passing both to trigger. Trigger shows correct stats and links to dashboard with clientId.</done>
</task>

</tasks>

<verification>
1. `npm run check-types -w react-sdk` passes
2. `npm run build -w react-sdk` produces both CJS and ESM outputs without errors
3. `npm run lint -w react-sdk` passes
4. The trigger no longer shows a "T" letter — it renders a dot
5. The "Open DevTools" button URL points to port 8260 with clientId param, not port 8265
</verification>

<success_criteria>

- Trigger is a minimal 12px dot inside 48px click target, green when connected, gray when disconnected
- Popover shows component/tool/thread counts, streaming status, and active thread
- Error badge appears on dot when errors > 0
- "Open DevTools" opens `http://{host}:8260/devtools?clientId={sessionId}` in new tab
- Position is configurable via prop
- All inline styles, no external CSS dependencies
- SDK builds successfully (CJS + ESM)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-devtools-trigger-fix/04-01-SUMMARY.md`
</output>
