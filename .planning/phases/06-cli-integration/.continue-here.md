---
phase: 06-cli-integration
task: UAT + Phase 7 planning
total_tasks: N/A
status: in_progress
last_updated: 2026-02-17T00:52:58.371Z
---

<current_state>
Phase 6 execution complete (2/2 plans). UAT started but paused after finding blockers. Three bug fixes committed during UAT. Was in plan mode designing Phase 7 (visibility improvements) when paused.
</current_state>

<completed_work>

- Phase 6 Plan 06-01: Magic init orchestrator — handleMagicInit with full pipeline, spinners, re-run detection, error recovery (commits 5484f25, a0e167e, 0ecd04a)
- Phase 6 Plan 06-02: CLI flag wiring — --magic in cli.ts, routing in init.ts, suggestion tip (commits 0bf686d, 4ab091a)
- Phase 6 verification: passed (06-VERIFICATION.md created)
- UAT Test 1 (--magic flag recognized): PASS
- UAT Test 2 (full pipeline): ISSUE — found 3 bugs, all fixed:
  1. fix(client-core): pass userKey as defaultQuery to SDK (commit 9a4f600) — V1 API requires userKey as query param not body
  2. fix(cli): validate filePath fields and improve prompt constraints (commit 2cee35d) — model returned descriptions as file paths
  3. feat(cli): inject Tambo SDK reference into plan generation prompt (commit 25068c7) — model needs actual Tambo API knowledge
- UAT Tests 6-7 (tests pass, types pass): PASS
- Created ecommerce test app at tmp/magic-cli/ with ProductCard, CartSummary, SearchBar, CategoryFilter, API routes, product data
- Ran magic init on ecommerce app — model appended garbage text to component files (registration instructions as literal text in source)
  </completed_work>

<remaining_work>

- UAT Tests 3-5 not yet run (normal init suggestion, --yes mode, re-run detection)
- Content generation bug: LLM output (suggestedRegistration, integrationPattern) appended raw to source files — needs output validation/sanitization in content-generator.ts
- Phase 7 planning started but not finished — scope confirmed as "visibility only":
  - Stream plan generation progress (onProgress callback exists but unused)
  - Better analysis stage feedback (real progress vs fake spinner text)
  - Per-file execution progress
    </remaining_work>

<decisions_made>

- userKey must be sent as defaultQuery on TamboAI SDK client (matching react-sdk pattern at react-sdk/src/providers/tambo-client-provider.tsx line 97)
- filePath fields validated with Zod refinement rejecting parentheses
- Tambo SDK reference (distilled from skills/) injected into plan generation prompt for accurate recommendations
- Phase 7 scope: visibility only (not content bugs) per user direction
  </decisions_made>

<blockers>

- Content generation bug: applyComponentRegistration() in user-confirmation/content-generator.ts blindly appends suggestedRegistration string to files. When LLM returns natural language instructions instead of code, garbage gets written to source files. This is a separate fix from Phase 7 visibility work.
  </blockers>

<context>
The magic init pipeline works end-to-end but produces poor quality output. Two categories of issues:

1. VISIBILITY (Phase 7): Users see silent spinners during long LLM calls, no streaming feedback, fake progress indicators during analysis. The onProgress callback in generatePlan() exists but magic-init.ts never uses it.

2. QUALITY (separate phase): The model hallucinates bad code, appends natural language to source files, and doesn't follow Tambo patterns correctly. The SDK reference injection helps but isn't sufficient — the content-generator needs output validation.

Key files for Phase 7:

- cli/src/commands/magic-init.ts (orchestrator with spinners)
- cli/src/utils/plan-generation/index.ts (has onProgress callback)
- cli/src/utils/code-execution/index.ts (execution progress)
- packages/client-core/src/run.ts (streams TEXT_MESSAGE_CONTENT events)

Ecommerce test app at tmp/magic-cli/ is set up but component files have garbage appended from last test run — needs cleanup before retesting.
</context>

<next_action>

1. Finish Phase 7 plan (was in plan mode — file at /Users/lachlan/.claude/plans/synthetic-floating-swan.md not yet written)
2. Or skip planning and directly fix the most impactful items:
   - Wire onProgress from generatePlan into magic-init.ts spinner text
   - Add per-file progress during execution phase
3. Clean up tmp/magic-cli/ component files before retesting
   </next_action>
