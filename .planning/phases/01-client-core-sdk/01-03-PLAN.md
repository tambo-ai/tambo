---
phase: 01-client-core-sdk
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/client-core/src/streaming.ts
  - packages/client-core/src/streaming.test.ts
  - packages/client-core/src/types.ts
  - packages/client-core/src/client.ts
  - packages/client-core/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Developer can stream SSE events from a thread run"
    - "Stream yields typed event objects as they arrive"
    - "Dropped connections automatically reconnect with Last-Event-ID"
    - "Stream can be cancelled via AbortSignal"
    - "Stalled streams timeout and reconnect"
  artifacts:
    - path: "packages/client-core/src/streaming.ts"
      provides: "SSE stream parsing and reconnection logic"
      exports: ["streamEvents"]
  key_links:
    - from: "packages/client-core/src/streaming.ts"
      to: "fetch API"
      via: "response.body.getReader() for SSE parsing"
      pattern: "getReader"
    - from: "packages/client-core/src/client.ts"
      to: "packages/client-core/src/streaming.ts"
      via: "exposes streaming method"
      pattern: "import.*from.*streaming"
---

<objective>
Implement SSE streaming with automatic reconnection and timeout handling.

Purpose: SDK-04 (stream responses in real-time) and SDK-08 (recover from dropped connections) — the real-time capability.
Output: streamEvents async generator that parses SSE, reconnects on drop, and yields typed events.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-client-core-sdk/01-RESEARCH.md
@.planning/phases/01-client-core-sdk/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SSE streaming with reconnection</name>
  <files>
    packages/client-core/src/types.ts
    packages/client-core/src/streaming.ts
    packages/client-core/src/client.ts
    packages/client-core/src/index.ts
  </files>
  <action>
    First, read the react-sdk streaming code to understand event types. Check:
    - react-sdk/src/v1/hooks/ for SSE event handling patterns
    - apps/api/src/threads/ for what events the API actually sends

    src/types.ts — Add streaming types:
    - StreamEvent: discriminated union of event types from the API. At minimum:
      { type: "message_start"; message: Message }
      | { type: "content_delta"; delta: { type: "text"; text: string } }
      | { type: "tool_call_start"; toolCall: { id: string; name: string } }
      | { type: "tool_call_args"; toolCallId: string; args: string }
      | { type: "tool_call_end"; toolCallId: string }
      | { type: "message_end"; message: Message }
      | { type: "error"; error: { message: string; code?: string } }
      | { type: "done" }
      Match actual API event types found in codebase — adapt as needed.
    - StreamOptions: { signal?: AbortSignal; maxReconnects?: number; reconnectDelay?: number; streamTimeout?: number }

    src/streaming.ts — streamEvents async generator:
    - async function* streamEvents(url: string, options: { headers: Record<string, string>; body?: unknown; signal?: AbortSignal; maxReconnects?: number; reconnectDelay?: number; streamTimeout?: number }): AsyncGenerator<StreamEvent>
    - Uses fetch with POST method (SSE over POST, not GET EventSource)
    - Reads response.body via getReader()
    - Parses SSE format: tracks "id:" lines for Last-Event-ID, yields parsed "data:" lines as StreamEvent
    - Buffer handling: accumulate partial lines, split on "\n", only process complete lines
    - Reconnection logic:
      - On network error or reader error: wait reconnectDelay (default 1000ms), retry with Last-Event-ID header
      - Track reconnect count, throw after maxReconnects (default 3)
      - Exponential backoff on reconnect delay: delay * 2^attempt
    - Timeout: create per-read timeout with AbortController. If no data received within streamTimeout (default 60000ms), abort and reconnect
    - Cancellation: respect options.signal, clean up reader on abort
    - On "done" event type or stream end: return normally (no reconnect)

    src/client.ts — Add stream method:
    - public async *stream(path: string, options?: { body?: unknown; signal?: AbortSignal } & StreamOptions): AsyncGenerator<StreamEvent>
    - Builds URL, adds auth headers, delegates to streamEvents

    src/index.ts — Add exports:
    - export { streamEvents } from "./streaming" (for advanced use)
    - export type { StreamEvent, StreamOptions } from "./types"

  </action>
  <verify>
    Run `npm run check-types -w packages/client-core` — no type errors.
  </verify>
  <done>streamEvents generator parses SSE, handles reconnection with Last-Event-ID, respects timeouts and abort signals.</done>
</task>

<task type="auto">
  <name>Task 2: Add streaming tests</name>
  <files>
    packages/client-core/src/streaming.test.ts
  </files>
  <action>
    src/streaming.test.ts — Test SSE streaming:

    Create a helper to mock fetch returning a ReadableStream of SSE-formatted data:
    - mockSSEResponse(events: Array<{ id?: string; data: string }>): creates a Response with readable body that emits SSE lines

    Tests:
    - Test: parses SSE data lines into StreamEvent objects
    - Test: handles multi-line buffering (partial chunks)
    - Test: tracks event IDs and sends Last-Event-ID on reconnect
    - Test: reconnects on network error up to maxReconnects
    - Test: stops reconnecting after maxReconnects exceeded (throws)
    - Test: respects AbortSignal cancellation
    - Test: does NOT reconnect after "done" event (clean exit)
    - Test: handles empty lines (SSE keepalive) without yielding events

    Use jest.useFakeTimers() for reconnect delay testing.

  </action>
  <verify>
    Run `npm test -w packages/client-core` — all tests pass.
    Run `npm run build -w packages/client-core` — builds clean.
  </verify>
  <done>Streaming tests cover SSE parsing, reconnection, timeout, cancellation. All pass.</done>
</task>

</tasks>

<verification>
- `npm test -w packages/client-core` — all tests pass
- `npm run build -w packages/client-core` — clean build
- Streaming handles reconnection, timeout, and cancellation correctly
</verification>

<success_criteria>

- SSE events stream as typed AsyncGenerator<StreamEvent>
- Connection drops trigger automatic reconnect with Last-Event-ID
- maxReconnects limit prevents infinite retry loops
- AbortSignal cancels stream cleanly
- Stream timeout detects stalled connections
  </success_criteria>

<output>
After completion, create `.planning/phases/01-client-core-sdk/01-03-SUMMARY.md`
</output>
