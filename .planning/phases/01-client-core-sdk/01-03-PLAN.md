---
phase: 01-client-core-sdk
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - packages/client-core/package.json
  - packages/client-core/src/client.ts
  - packages/client-core/src/client.test.ts
  - packages/client-core/src/threads.ts
  - packages/client-core/src/threads.test.ts
  - packages/client-core/src/types.ts
  - packages/client-core/src/query.ts
  - packages/client-core/src/query.test.ts
  - packages/client-core/src/index.ts
autonomous: true

must_haves:
  truths:
    - "TamboClient wraps @tambo-ai/typescript-sdk for all API requests"
    - "Thread operations use typescript-sdk client methods, not raw fetch"
    - "@tanstack/query-core QueryClient caches thread and message data"
    - "Query cache invalidates correctly on mutations (create/delete thread, send message)"
    - "Developer can access QueryClient for custom cache control"
    - "All existing tests pass or are updated to match new implementation"
  artifacts:
    - path: "packages/client-core/src/client.ts"
      provides: "TamboClient wrapping typescript-sdk + QueryClient"
    - path: "packages/client-core/src/query.ts"
      provides: "Query key factories and cache utilities"
    - path: "packages/client-core/src/threads.ts"
      provides: "ThreadsClient using typescript-sdk + query cache"
  key_links:
    - from: "packages/client-core/src/client.ts"
      to: "@tambo-ai/typescript-sdk"
      via: "wraps TamboAI client instance"
      pattern: "import.*from.*@tambo-ai/typescript-sdk"
    - from: "packages/client-core/src/client.ts"
      to: "@tanstack/query-core"
      via: "creates and owns QueryClient"
      pattern: "import.*QueryClient.*from.*@tanstack/query-core"
    - from: "packages/client-core/src/threads.ts"
      to: "packages/client-core/src/query.ts"
      via: "uses query keys for cache operations"
      pattern: "import.*from.*query"
---

<objective>
Refactor client-core to use @tambo-ai/typescript-sdk as the API layer and @tanstack/query-core for caching.

Purpose: Replace raw fetch with the official SDK client (already handles auth, retries, pagination). Add TanStack query-core for cache management (thread lists, thread details, messages). This makes client-core a thin orchestration layer rather than a reimplementation of HTTP concerns.

Output: TamboClient wraps typescript-sdk, ThreadsClient uses SDK methods with query caching, all existing tests updated.
</objective>

<execution_context>
@/Users/lachlan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lachlan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-client-core-sdk/01-RESEARCH.md
@.planning/phases/01-client-core-sdk/01-01-SUMMARY.md
@.planning/phases/01-client-core-sdk/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor TamboClient to wrap typescript-sdk + add QueryClient</name>
  <files>
    packages/client-core/package.json
    packages/client-core/src/types.ts
    packages/client-core/src/query.ts
    packages/client-core/src/client.ts
    packages/client-core/src/client.test.ts
    packages/client-core/src/index.ts
  </files>
  <action>
    First, read the existing code to understand current implementation:
    - packages/client-core/src/client.ts (current raw fetch TamboClient)
    - packages/client-core/src/types.ts (current types)
    - node_modules/@tambo-ai/typescript-sdk/src/client.ts (SDK client API)
    - node_modules/@tambo-ai/typescript-sdk/src/index.ts (SDK exports)

    package.json — Add dependencies:
    - "@tambo-ai/typescript-sdk": "*" (workspace protocol or current version)
    - "@tanstack/query-core": "^5" (framework-agnostic query)
    Then run `npm install` from repo root.

    src/types.ts — Update TamboClientOptions:
    - Keep apiKey and baseUrl (pass through to typescript-sdk)
    - Add optional sdkClient field for injecting a pre-configured SDK client
    - Add optional queryClient field for injecting a pre-configured QueryClient
    - Remove timeout/maxRetries (SDK handles these internally)
    - Keep any types that aren't duplicated by the SDK; re-export SDK types where overlap

    src/query.ts — Query key factories + cache utilities:
    - threadKeys: { all: ["threads"], list: (projectId) => [...], detail: (threadId) => [...], messages: (threadId) => [...] }
    - Export key factories for use in threads.ts and by consumers

    src/client.ts — Refactor TamboClient:
    - Constructor creates:
      1. TamboAI SDK client (from @tambo-ai/typescript-sdk) with apiKey + baseUrl
      2. QueryClient (from @tanstack/query-core) with sensible defaults (staleTime, gcTime)
    - Expose: this.sdk (the typescript-sdk client instance) for direct SDK access
    - Expose: this.queryClient for cache control
    - Remove: raw fetch method, retry logic wrapping (SDK handles this)
    - Keep: the public API surface (threads property, etc.) but backed by SDK

    src/client.test.ts — Update tests:
    - Mock @tambo-ai/typescript-sdk instead of global fetch
    - Test that TamboClient creates SDK client with correct apiKey/baseUrl
    - Test that QueryClient is created and accessible
    - Remove retry-specific tests (SDK handles retries)

    src/index.ts — Update exports:
    - Re-export useful SDK types (ThreadCreateResponse, etc.) for convenience
    - Export query key factories
    - Export QueryClient type from @tanstack/query-core

  </action>
  <verify>
    Run `npm run check-types -w packages/client-core` — no type errors.
    Run `npm run build -w packages/client-core` — builds clean.
  </verify>
  <done>TamboClient wraps typescript-sdk and owns a QueryClient. Raw fetch removed.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor ThreadsClient to use SDK + query cache</name>
  <files>
    packages/client-core/src/threads.ts
    packages/client-core/src/threads.test.ts
    packages/client-core/src/query.test.ts
  </files>
  <action>
    First, read current ThreadsClient and the SDK thread methods:
    - packages/client-core/src/threads.ts (current implementation)
    - node_modules/@tambo-ai/typescript-sdk/src/resources/threads/threads.ts
    - node_modules/@tambo-ai/typescript-sdk/src/resources/threads/messages.ts
    - node_modules/@tambo-ai/typescript-sdk/src/resources/threads/runs.ts

    src/threads.ts — Refactor ThreadsClient:
    - Constructor receives TamboClient (which has .sdk and .queryClient)
    - create(): Use queryClient.fetchQuery with sdk.threads.create(), invalidate thread list cache
    - list(): Use queryClient.fetchQuery with sdk.threads.list(), cache with threadKeys.list
    - get(): Use queryClient.fetchQuery with sdk.threads.retrieve(), cache with threadKeys.detail
    - delete(): Use sdk.threads.delete(), invalidate caches (list + detail)
    - sendMessage(): Use sdk.threads.runs.run() or sdk.threads.messages (check which is correct), invalidate thread messages cache
    - All methods: proper cache invalidation on mutations
    - Optional: expose prefetch methods for warming cache

    src/threads.test.ts — Update tests:
    - Mock sdk.threads.create/list/retrieve/delete instead of fetch
    - Test cache behavior: second get() with same ID returns cached (no SDK call)
    - Test invalidation: create() invalidates list cache
    - Test that SDK types flow through correctly

    src/query.test.ts — Query key tests:
    - Test key factory outputs correct arrays
    - Test key hierarchy (detail is subset of list for invalidation)

  </action>
  <verify>
    Run `npm test -w packages/client-core` — all tests pass.
    Run `npm run build -w packages/client-core` — builds clean.
    Run `npm run check-types -w packages/client-core` — clean.
  </verify>
  <done>ThreadsClient uses typescript-sdk for API calls and query-core for caching. Cache invalidates on mutations. All tests pass.</done>
</task>

</tasks>

<verification>
- `npm test -w packages/client-core` — all tests pass
- `npm run build -w packages/client-core` — clean dual build
- `npm run check-types -w packages/client-core` — no errors
- No more raw fetch calls in client-core (all go through typescript-sdk)
- QueryClient caches thread data correctly
</verification>

<success_criteria>

- typescript-sdk handles all HTTP communication (auth, retries, pagination)
- @tanstack/query-core manages caching with proper invalidation
- Existing public API surface preserved (TamboClient, ThreadsClient methods)
- All tests updated and passing
- No raw fetch calls remain in client-core
  </success_criteria>

<output>
After completion, create `.planning/phases/01-client-core-sdk/01-03-SUMMARY.md`
</output>
